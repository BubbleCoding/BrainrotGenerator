<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Generating… Please wait</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
<style>
:root { --accent:#5cf; --bg:#0a0a0a; --fg:#eaeaea; }
* { box-sizing: border-box; }
html, body { height:100%; }
body { margin:0; background:radial-gradient(circle at center, #111 0%, #000 100%); color:var(--fg);
       font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; display:flex; align-items:center; justify-content:center; }
.container { width:min(760px, 92vw); padding:28px; border-radius:16px; background:#0f0f0f; border:2px solid #333;
            box-shadow: 0 20px 40px rgba(0,0,0,.5), inset 0 -4px 20px rgba(0,0,0,.6); text-align:center; }
h1 { margin:0 0 8px; font-family:'Orbitron', sans-serif; letter-spacing:1px; font-weight:500; text-transform:uppercase; }
.status { opacity:.9; min-height:24px; }
.progress { margin:22px 0 10px; height:6px; background:#1a1a1a; border-radius:999px; overflow:hidden; border:1px solid #2a2a2a; }
.bar { width:0%; height:100%; background:linear-gradient(90deg, var(--accent), #66e); transition: width .35s ease; }
.steps { display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; margin-top:16px; }
.step { padding:10px; border-radius:10px; background:#121212; border:1px solid #222; font-size:14px; opacity:.6; }
.step.active { border-color: var(--accent); box-shadow: 0 0 10px rgba(100,200,255,.15); opacity:1; }
.spinner { width:72px; height:72px; margin:18px auto 10px; border-radius:50%; border:4px solid #1f1f1f;
           border-top-color: var(--accent); animation: spin 1s linear infinite; }
.glow { height:2px; background:linear-gradient(90deg, transparent, var(--accent), transparent); opacity:.7;
        box-shadow:0 0 12px var(--accent); margin:8px 0 0; }
.actions { margin-top:16px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
button { font-size:16px; padding:10px 14px; border-radius:10px; border:1px solid #333; background:#161616; color:#fff; cursor:pointer; }
button.primary { background: var(--accent); color:#001018; font-weight:800; border:none; }
.small { font-size:12px; opacity:.7; margin-top:8px; }
@keyframes spin { to { transform: rotate(360deg); } }
@media (prefers-reduced-motion: reduce){
  .spinner { animation-duration: 2.5s; }
}
</style>
</head>
<body>
  <div class="container">
    <h1>Generating your Brainrot</h1>
    <div class="status" id="status">Connecting…</div>
    <div class="spinner"></div>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <div class="steps">
      <div class="step" id="s1">Queued</div>
      <div class="step" id="s2">Composing prompt</div>
      <div class="step" id="s3">Generating image</div>
      <div class="step" id="s4">Saving</div>
    </div>
    <div class="glow"></div>
    <div class="actions">
      <button onclick="window.location.href='/'">⟵ Back to Slot</button>
      <button class="primary" onclick="window.location.reload()">Retry</button>
    </div>
    <div class="small">Tip: you can keep this tab open while you play another round.</div>
  </div>

<script>
let ws;
const statusEl = document.getElementById('status');
const barEl = document.getElementById('bar');
const steps = [null, s1, s2, s3, s4];
let phase = 1; // start at Queued

function setStatus(msg){ statusEl.textContent = msg; }
function setPhase(p){
  phase = Math.max(1, Math.min(4, p));
  for (let i=1;i<=4;i++){
    steps[i].classList.toggle('active', i<=phase);
  }
  const widths = [0, 10, 45, 80, 100];
  barEl.style.width = widths[phase] + '%';
}

function connect(){
  setStatus('Connecting…');
  ws = new WebSocket(`ws://${location.host}/ws`);
  ws.onopen = ()=>{
    setStatus('Connected. Waiting for the image…');
    /* keep current phase; server will drive via messages */
  };
  ws.onmessage = (ev)=>{
    const msg = JSON.parse(ev.data);
    if (msg.type === 'init') { setPhase(1); setStatus('Queued…'); }
    if (msg.type === 'phase') { if (msg.step) setPhase(msg.step); if (msg.status) setStatus(msg.status); }
    if (msg.type === 'all_stopped') { setPhase(2); setStatus('Composing prompt…'); }
    if (msg.type === 'reel_stopped') { /* ignore here */ }
    if (msg.type === 'image_ready') {
      setPhase(4);
      setStatus('Ready! Redirecting…');
      const url = "/gallery.html?url=" + encodeURIComponent(msg.url)
                + "&name=" + encodeURIComponent(msg.italian_name)
                + "&prompt=" + encodeURIComponent(msg.prompt);
      setTimeout(()=>{ window.location.href = url; }, 400);
    }
    if (msg.type === 'error') { setStatus('Error: ' + (msg.message||'unknown')); }
  };
  ws.onerror = ()=> setStatus('Connection error.');
  ws.onclose = ()=> setStatus('Disconnected. You can retry.');
}
setPhase(1);
connect();
</script>
</body>
</html>
