<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Slot Machine UI — 3D Cylinder (User Choice)</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet"/>
<style>
  :root { --accent:#5cf; --bg:#0a0a0a; --panel:#111; }
  html, body { height:100%; }
  body { margin:0; background: radial-gradient(circle at center, #111 0%, #000 100%); color:#eaeaea; font-family:ui-sans-serif, system-ui, -apple-system; }
  header { text-align:center; padding:24px 12px; font-weight:600; letter-spacing:.5px; }
  .status { text-align:center; padding:8px; min-height:24px; opacity:.9; }
  .wrap { display:grid; grid-template-columns:1fr 1fr 1fr; gap:24px; height:calc(100vh - 190px); padding:24px; box-sizing:border-box; }
  .reel { position:relative; border:2px solid #444; border-radius:16px; background:linear-gradient(to bottom,#1a1a1a,#0f0f0f); box-shadow:inset 0 2px 6px rgba(255,255,255,.08), inset 0 -3px 10px rgba(0,0,0,.6), 0 10px 24px rgba(0,0,0,.35); overflow:hidden; }
  .scene { width:100%; height:100%; perspective:1000px; perspective-origin:50% 50%; position:relative; }
  .cyl { width:100%; height:100%; position:absolute; inset:0; transform-style:preserve-3d; will-change:transform; }
  .panel { position:absolute; top:50%; left:50%; width:86%; height:92px; margin-left:-43%; margin-top:-46px; display:flex; align-items:center; justify-content:center; font-size:clamp(10px,2vw,48px); text-shadow:0 2px 2px rgba(0,0,0,.3); color:#eaeaea; backface-visibility:hidden; user-select:none; }
  .reel::after { content:""; position:absolute; left:0; right:0; top:50%; height:0; border-top:2px solid var(--accent); opacity:.5; transform: translateY(-1px); pointer-events:none; z-index:5; }
  .fadeMask { position:absolute; inset:0; pointer-events:none; z-index:4; background:linear-gradient(to bottom, rgba(10,10,10,.95), rgba(10,10,10,0) 20%, rgba(10,10,10,0) 80%, rgba(10,10,10,.95)); }
  .stopBadge { position:absolute; bottom:16px; right:16px; background:#1c1; color:#012; font-weight:800; padding:8px 12px; border-radius:12px; display:none; z-index:6; transform:scale(.8); opacity:0; transition:transform .18s ease, opacity .18s ease; }
  .stopBadge.show { display:block !important; transform:scale(1); opacity:1; }

  /* Loading overlay */
  .loading-overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); backdrop-filter: blur(3px); z-index:999; }
  .loading-overlay.show { display:flex; }
  .loading-card { min-width:320px; max-width:520px; padding:24px; border-radius:16px; background:linear-gradient(180deg,#0f1216,#0b0d10); box-shadow:0 12px 40px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.06); text-align:center; }
  .spinner { width:52px; height:52px; border:5px solid rgba(255,255,255,.15); border-top-color:var(--accent); border-radius:50%; margin:0 auto 16px; animation:spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .progressbar { height:8px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden; margin-top:10px; }
  .progressbar > div { width:40%; height:100%; border-radius:999px; background:linear-gradient(90deg, transparent, var(--accent), transparent); animation: slide 1.2s ease-in-out infinite; }
  @keyframes slide { 0%{margin-left:-40%;width:20%} 50%{margin-left:20%;width:60%} 100%{margin-left:100%;width:20%} }
</style>
</head>
<body>
<header><div class="status" id="status">Stop each reel with the symbol you want on the payline.</div></header>

<div class="wrap">
  <div class="reel"><div class="scene"><div class="cyl" id="cyl0"></div></div><div class="fadeMask"></div><div class="stopBadge" id="sb0">Stopped</div></div>
  <div class="reel"><div class="scene"><div class="cyl" id="cyl1"></div></div><div class="fadeMask"></div><div class="stopBadge" id="sb1">Stopped</div></div>
  <div class="reel"><div class="scene"><div class="cyl" id="cyl2"></div></div><div class="fadeMask"></div><div class="stopBadge" id="sb2">Stopped</div></div>
</div>

<footer class="controls">
  <button onclick="stopReel(0)">Stop A</button>
  <button onclick="stopReel(1)">Stop B</button>
  <button onclick="stopReel(2)">Stop C</button>
  <button class="primary" id="resetBtn" onclick="resetAll()">Reset</button>
  <button class="primary" onclick="window.location.href='/gallery.html'">📸 View Gallery</button>
</footer>

<div id="loadingOverlay" class="loading-overlay" aria-hidden="true">
  <div class="loading-card" role="dialog" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loading-title" id="loadingTitle">Working…</div>
    <div class="loading-sub" id="loadingSub">Composing prompt & generating your brainrot.</div>
    <div class="progressbar"><div></div></div>
  </div>
</div>

<script>
const ROW_H = 92;
const ROT_SPEEDS = [0.025, 0.025, 0.025]; // deg/ms
let ws;
let reels = [[],[],[]];
let spinning = [true,true,true];
let rotX = [0,0,0];
let lastTS = performance.now();
let cylEls = [];
let badgeEls = [];

function showOverlay(){ document.getElementById('loadingOverlay').classList.add('show'); }
function hideOverlay(){ document.getElementById('loadingOverlay').classList.remove('show'); }
function setStatus(s){ document.getElementById('status').textContent = s; }

function connect(){
  ws = new WebSocket(`ws://${location.host}/ws`);
  ws.onmessage = (ev)=>{
    const msg = JSON.parse(ev.data);

    if (msg.type === 'init') { initUI(msg.reels); return; }

    if (msg.type === 'gpio_press') {        // <<< GPIO press → client decides visible symbol
      stopReelFromGPIO(msg.reel);
      return;
    }

    if (msg.type === 'reel_stopped') {      // server confirmation → minimal snap to that symbol
      onReelStopped(msg.reel, msg.symbol);
      return;
    }

    if (msg.type === 'all_stopped') { showOverlay(); return; }
    if (msg.type === 'image_ready') {
      hideOverlay();
      window.location.href = "/gallery.html?url=" + encodeURIComponent(msg.url)
                           + "&name=" + encodeURIComponent(msg.italian_name)
                           + "&prompt=" + encodeURIComponent(msg.prompt);
      return;
    }
    if (msg.type === 'error') { hideOverlay(); setStatus("⚠️ " + msg.message); return; }
  };
  ws.onclose = ()=>{ hideOverlay(); setStatus("Disconnected. Reconnecting…"); setTimeout(connect, 800); };
}

function buildCylinder(i){
  const cyl = document.getElementById(`cyl${i}`);
  cyl.innerHTML = "";
  const items = reels[i]; const n = items.length; const step = 360 / n; const R = (ROW_H * n) / (2 * Math.PI);
  items.forEach((txt, idx)=>{
    const panel = document.createElement('div');
    panel.className = 'panel'; panel.textContent = txt;
    panel.style.transform = `rotateX(${idx * step}deg) translateZ(${R}px)`;
    cyl.appendChild(panel);
  });
  cyl.dataset.step = step.toString();
  rotX[i] = 0; cyl.style.transform = `rotateX(${rotX[i]}deg)`;
}
function initUI(reelData){
  reels = [reelData[0], reelData[1], reelData[2]];
  cylEls = [document.getElementById('cyl0'), document.getElementById('cyl1'), document.getElementById('cyl2')];
  badgeEls = [document.getElementById('sb0'), document.getElementById('sb1'), document.getElementById('sb2')];
  for (let i=0;i<3;i++) buildCylinder(i);
  spinning = [true,true,true];
  lastTS = performance.now(); requestAnimationFrame(tick);
}
function tick(now){
  const dt = now - lastTS; lastTS = now;
  for (let i=0;i<3;i++){
    const cyl = cylEls[i]; if (!cyl) continue;
    if (spinning[i]) rotX[i] = (rotX[i] + ROT_SPEEDS[i] * dt) % 360;
    cyl.style.transform = `rotateX(${rotX[i]}deg)`;
  }
  requestAnimationFrame(tick);
}

function currentSymbol(i){
  const list = reels[i];
  const n = list.length;
  const step = 360 / n;
  const idx = Math.round((-rotX[i]) / step) % n;
  const wrapped = (idx + n) % n;
  return list[wrapped];
}

function stopReel(i){
  if (!spinning[i]||!ws||ws.readyState!==1) return;
  spinning[i]=false;
  const symbol = currentSymbol(i); // click path decides symbol
  ws.send(JSON.stringify({type:"stop_reel", reel:i, symbol}));
  if (spinning.every(v=>!v)) document.querySelectorAll('button:not(.primary)').forEach(b=>b.disabled=true);
}

function stopReelFromGPIO(i){
  if (!spinning[i]||!ws||ws.readyState!==1) return;
  const symbol = currentSymbol(i); // GPIO path also uses what the user sees
  spinning[i]=false;
  ws.send(JSON.stringify({type:"stop_reel", reel:i, symbol}));
  if (spinning.every(v=>!v)) document.querySelectorAll('button:not(.primary)').forEach(b=>b.disabled=true);
}

function onReelStopped(i, symbol){
  // Set badge, stop spinning, and snap by shortest path to server-confirmed symbol
  spinning[i] = false;
  badgeEls[i].textContent = `Stopped: ${symbol}`;
  badgeEls[i].style.display='block';

  const list = reels[i]; const idx = list.indexOf(symbol); if (idx<0) return;
  const step = 360 / list.length;

  // normalize current/target to [0,360), compute shortest diff in [-180,180]
  const curNorm = ((rotX[i] % 360) + 360) % 360;
  const tgtNorm = ((-idx * step) % 360 + 360) % 360;
  let diff = tgtNorm - curNorm;
  if (diff > 180) diff -= 360;
  if (diff < -180) diff += 360;

  const startAbs = rotX[i];
  const destAbs  = startAbs + diff;

  const frames = 18;
  let f = 0;
  function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }
  (function anim(){
    f++;
    const t = Math.min(f/frames, 1);
    const val = startAbs + diff * easeOutCubic(t);
    rotX[i] = val;
    cylEls[i].style.transform = `rotateX(${val}deg)`;
    if (f < frames) requestAnimationFrame(anim);
    else { rotX[i] = destAbs; cylEls[i].style.transform = `rotateX(${destAbs}deg)`; }
  })();
}

function resetAll(){
  badgeEls.forEach(b=>{ b.classList.remove('show'); b.style.display='none'; b.textContent='Stopped';});
  spinning=[true,true,true];
  setStatus("Ready. Stop each reel with your chosen symbol.");
  hideOverlay();
  document.querySelectorAll('button:not(.primary)').forEach(b=>b.disabled=false);
  if(ws&&ws.readyState===1) ws.send(JSON.stringify({type:"reset"}));
}

connect();
</script>
</body>
</html>
