<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Slot Machine UI ‚Äî 3D Cylinder (User Choice)</title>
<style>
/* ‚Ä¶ your original CSS exactly as-is ‚Ä¶ */
</style>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet"/></head>
<body>
<header>
  <div class="status" id="status">Stop each reel with the symbol you want on the payline.</div>
</header>

<div class="wrap">
  <div class="reel"><div class="scene"><div class="cyl" id="cyl0"></div></div><div class="fadeMask"></div><div class="stopBadge" id="sb0">Stopped</div></div>
  <div class="reel"><div class="scene"><div class="cyl" id="cyl1"></div></div><div class="fadeMask"></div><div class="stopBadge" id="sb1">Stopped</div></div>
  <div class="reel"><div class="scene"><div class="cyl" id="cyl2"></div></div><div class="fadeMask"></div><div class="stopBadge" id="sb2">Stopped</div></div>
</div>

<footer class="controls">
  <button onclick="stopReel(0)">Stop A</button>
  <button onclick="stopReel(1)">Stop B</button>
  <button onclick="stopReel(2)">Stop C</button>
  <button class="primary" id="resetBtn" onclick="resetAll()">Reset</button>
  <button class="primary" onclick="window.location.href='/gallery.html'">üì∏ View Gallery</button>
</footer>

<!-- LOADING OVERLAY (unchanged) -->
<div id="loadingOverlay" class="loading-overlay" aria-hidden="true">
  <div class="loading-card" role="dialog" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loading-title" id="loadingTitle">Working‚Ä¶</div>
    <div class="loading-sub" id="loadingSub">Composing prompt & generating your brainrot.</div>
    <div class="progressbar"><div></div></div>
    <div class="hint">This might take a moment if the image model is busy.</div>
  </div>
</div>

<script>
/* ===== your original JS up to connect() remains the same ===== */
const ROW_H = 92;
const ROT_SPEEDS = [0.025, 0.025, 0.025]; // deg/ms
let ws; let reels = [[],[],[]]; let spinning = [true,true,true];
let rotX = [0,0,0]; let lastTS = performance.now(); let cylEls = []; let badgeEls = [];

function showOverlay(title="Working‚Ä¶", sub="Composing prompt & generating your brainrot."){
  const o = document.getElementById('loadingOverlay');
  document.getElementById('loadingTitle').textContent = title;
  document.getElementById('loadingSub').textContent = sub;
  o.classList.add('show'); o.setAttribute('aria-hidden', 'false');
}
function hideOverlay(){ const o = document.getElementById('loadingOverlay'); o.classList.remove('show'); o.setAttribute('aria-hidden', 'true'); }
function setStatus(s){ document.getElementById('status').textContent = s; }

function connect(){
  ws = new WebSocket(`ws://${location.host}/ws`);
  ws.onmessage = (ev)=>{
    const msg = JSON.parse(ev.data);

    if (msg.type === 'debug') { console.log('[WS debug]', msg.msg); return; }
    if (msg.type === 'init')  { initUI(msg.reels); return; }

    /* >>> NEW: GPIO press ‚Äî client decides visible symbol, then sends stop_reel */
    if (msg.type === 'gpio_press') { stopReelFromGPIO(msg.reel); return; }

    if (msg.type === 'reel_stopped') {
      onReelStopped(msg.reel, msg.symbol);
      return;
    }
    if (msg.type === 'all_stopped') {
      setStatus("Composing prompt‚Ä¶");
      showOverlay("Brewing your brainrot‚Ä¶","Composing prompt & generating image.");
      return;
    }
    if (msg.type === 'image_ready') {
      setStatus("Image ready!");
      hideOverlay();
      window.location.href = "/gallery.html?url=" + encodeURIComponent(msg.url)
                           + "&name=" + encodeURIComponent(msg.italian_name)
                           + "&prompt=" + encodeURIComponent(msg.prompt);
      return;
    }
    if (msg.type === 'error') { hideOverlay(); setStatus("‚ö†Ô∏è " + msg.message); return; }
  };
  ws.onclose = ()=>{ setStatus("Disconnected. Reconnecting‚Ä¶"); hideOverlay(); setTimeout(connect, 800); };
}

function buildCylinder(i){ /* unchanged */ }
function initUI(reelData){ /* unchanged */ }
function tick(now){ /* unchanged */ }
function currentSymbol(i){ /* unchanged */ }

function stopReel(i){
  if (!spinning[i]||!ws||ws.readyState!==1) return;
  spinning[i]=false;
  const symbol = currentSymbol(i);
  ws.send(JSON.stringify({type:"stop_reel", reel:i, symbol}));
  setStatus(`Locked ${"ABC"[i]}: ${symbol}.`);
  if (spinning.every(v=>!v)) { document.querySelectorAll('button:not(.primary)').forEach(b=>b.disabled=true); }
}

/* >>> NEW: GPIO path mirrors the click path and uses the visible symbol */
function stopReelFromGPIO(i){
  if (!spinning[i]||!ws||ws.readyState!==1) return;
  spinning[i]=false;
  const symbol = currentSymbol(i);
  ws.send(JSON.stringify({type:"stop_reel", reel:i, symbol}));
  if (spinning.every(v=>!v)) { document.querySelectorAll('button:not(.primary)').forEach(b=>b.disabled=true); }
}

/* onReelStopped with shortest-path snap (already in your file, kept intact) */
function onReelStopped(i, symbol) {
  spinning[i] = false;
  badgeEls[i].textContent = `Stopped: ${symbol}`;
  badgeEls[i].style.display = 'block';

  const list = reels[i];
  const idx = list.indexOf(symbol);
  if (idx < 0) return;

  const step    = 360 / list.length;
  const current = rotX[i];
  const targetAbs = -idx * step;

  let diff = (targetAbs - current) % 360;
  if (diff > 180) diff -= 360;
  if (diff < -180) diff += 360;
  const dest = current + diff;

  const frames = 18; let frame = 0;
  function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }
  (function animate() {
    frame++;
    const t = Math.min(frame / frames, 1);
    const val = current + diff * easeOutCubic(t);
    rotX[i] = val;
    cylEls[i].style.transform = `rotateX(${val}deg)`;
    if (frame < frames) requestAnimationFrame(animate);
    else { rotX[i] = dest; cylEls[i].style.transform = `rotateX(${dest}deg)`; }
  })();

  if (spinning.every(v=>!v)) { document.querySelectorAll('button:not(.primary)').forEach(b=>b.disabled=true); }
}

function resetAll(){ /* unchanged */ }
connect();
</script>

<script>
/* your ‚ÄúPOLISH PACK JS v1‚Äù block stays exactly as-is */
</script>
</body>
</html>
